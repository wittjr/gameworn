{% extends 'memorabilia/base.html' %}
{% load memorabilia_extras %}

{% block head_title %}
    {{ title }}
{% endblock head_title %}

{% block extrahead %}
    {{ image_formset.media }}
{% endblock extrahead %}

{% block navigation %}
    {% if user.is_authenticated %}
        {% if user.id == collection.owner_uid or user.is_superuser %}
            {% url 'memorabilia:edit_collection' collection.id as the_url %}
            {% include "memorabilia/navitem.html" with link=the_url label="Edit Collection" %}

            {% url 'memorabilia:delete_collection' collection.id as the_url %}
            {% include "memorabilia/navitem.html" with link=the_url label="Delete Collection" %}

            {% url 'memorabilia:create_collectible' collection.id as the_url %}
            {% include "memorabilia/navitem.html" with link=the_url label="Add Collectible" %}
        {% endif %}
    {% endif %}
{% endblock navigation %}

{% block breadcrumb %}
    {% url 'memorabilia:list_collections' as the_url %}
    {% include 'memorabilia/breadcrumb.html' with url=the_url label="Collections" %}
    {% if collectible %}
        {% url 'memorabilia:collection' collectible.collection.id as the_url %}
        {% include 'memorabilia/breadcrumb.html' with url=the_url label=collectible.collection.title %}
        {% url 'memorabilia:collectible' collection_id=collectible.collection.id pk=collectible.id as the_url %}
        {% include 'memorabilia/breadcrumb.html' with url=the_url label=collectible.title %}
    {% else %}
        {% url 'memorabilia:collection' collection.id as the_url %}
        {% include 'memorabilia/breadcrumb.html' with url=the_url label=collection.title %}
    {% endif %}
{% endblock breadcrumb %}

{% block content %}
<h1 class="mb-6 text-4xl text-center font-extrabold tracking-tight leading-none md:text-5xl lg:text-6xl">{{ title }}</h1>

<form method="post" enctype="multipart/form-data" novalidate class="bg-white rounded-lg shadow p-4">
    {% csrf_token %}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pb-4">
    <!-- Left Column - Images -->
    <div class="grid gap-4 w-full">
        <div class="bg-white p-4 rounded-lg shadow">
            <h2 class="text-xl font-semibold mb-4">Images</h2>
            {% include 'memorabilia/flickr_album_widget.html' with formset=image_formset %}
        </div>
    </div>

    <!-- Right Column - Form Fields -->
    <div class="w-full">
            {% if form.non_field_errors %}
                <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-4">
                    {% for error in form.non_field_errors %}
                        <p class="text-red-700">{{ error }}</p>
                    {% endfor %}
                </div>
            {% endif %}

            <table class="table-auto sm:rounded-lg border shadow-md w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400">            
                {% for field in form.visible_fields %}
                    {% if field.name != 'primary_image' %}
                        <tr class="odd:bg-white odd:dark:bg-gray-900 even:bg-gray-50 even:dark:bg-gray-800 border-t border-b dark:border-gray-700">
                            <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">{{ field.label_tag }}</th>
                            <td class="px-6 py-2">
                                {{ field }}
                                {% if field.name == 'league' %}
                                    <datalist id="league-list">
                                        {% for l in leagues %}
                                            <option value="{{ l.key }}" label="{{ l.name }}"></option>
                                        {% endfor %}
                                    </datalist>
                                {% endif %}
                                {% if field.name == 'team' %}
                                    <datalist id="team-list"></datalist>
                                    <script>
                                      (function() {
                                        function fillTopOptionOnTab(e, inputEl, listId) {
                                          if (e.key !== 'Tab') return;
                                          const list = document.getElementById(listId);
                                          if (!list) return;
                                          const q = (inputEl.value || '').trim().toLowerCase();
                                          if (!q) return;
                                          const opts = Array.from(list.options || []);
                                          // Prefer startsWith match; fallback to contains
                                          let match = opts.find(o => (o.value || '').toLowerCase().startsWith(q));
                                          if (!match) match = opts.find(o => (o.value || '').toLowerCase().includes(q));
                                          if (match) {
                                            inputEl.value = match.value;
                                            // Do not prevent default so Tab still moves focus forward
                                            return true;
                                          }
                                          return false;
                                        }
                                        function populateTeams(leagueVal) {
                                          const list = document.getElementById('team-list');
                                          if (!list) return;
                                          list.innerHTML = '';
                                          if (!leagueVal) return;
                                          fetch(`{% url 'memorabilia:get_teams' %}?league=${encodeURIComponent(leagueVal)}`)
                                            .then(r => r.json())
                                            .then(data => {
                                              (data.teams || []).forEach(name => {
                                                const opt = document.createElement('option');
                                                opt.value = name;
                                                list.appendChild(opt);
                                              });
                                            })
                                            .catch(() => {});
                                        }
                                        // On load
                                        document.addEventListener('DOMContentLoaded', function() {
                                          const leagueInput = document.querySelector('[name="league"]');
                                          const teamInput = document.querySelector('[name="team"]');
                                          if (leagueInput) {
                                            populateTeams(leagueInput.value);
                                            leagueInput.addEventListener('input', function(e) {
                                              populateTeams(e.target.value);
                                            });
                                            leagueInput.addEventListener('keydown', function(e) {
                                              const filled = fillTopOptionOnTab(e, leagueInput, 'league-list');
                                              if (filled) {
                                                // Ensure teams datalist updates before focus leaves
                                                populateTeams(leagueInput.value);
                                              }
                                            });
                                          }
                                          if (teamInput) {
                                            teamInput.addEventListener('keydown', function(e) {
                                              fillTopOptionOnTab(e, teamInput, 'team-list');
                                            });
                                          }
                                          // If team has a value and list empty, keep it; options populate lazily
                                        });
                                      })();
                                    </script>
                                {% endif %}
                                {% if field.help_text %}
                                    <p class="text-xs text-gray-500 mt-1">{{ field.help_text }}</p>
                                {% endif %}
                                {% if field.errors %}
                                    <div class="form-errors">{{ field.errors }}</div>
                                {% endif %}
                            </td>
                        </tr>
                    {% endif %}
                {% endfor %}
                {# Ensure collection is submitted even though it's not rendered visibly #}
                {% for hidden in form.hidden_fields %}
                    {{ hidden }}
                {% endfor %}
            </table>

            <div class="flex justify-end space-x-4 mt-6">
                <button
                    type="button"
                    onclick="history.back()"
                    class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Cancel
                </button>
                <button
                    type="submit"
                    class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Save Changes
                </button>
            </div>
    </div>
    </div>
</form>
{% endblock content %}
